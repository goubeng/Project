<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>项目全过程智能监管驾驶舱</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* 补全样式：不影响原有布局，仅增加细节标签 */
    .variance-tag {
        position: absolute; bottom: -20px; font-size: 11px;
        padding: 1px 6px; border-radius: 4px; white-space: nowrap;
    }
    .variance-tag.delay { background: #fff1f0; color: #f5222d; border: 1px solid #ffa39e; }
    .variance-tag.ahead { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    
    .risk-score-display { font-size: 13px; color: #8c8c8c; margin-top: 5px; }
    .risk-score-val { color: #faad14; font-weight: bold; font-size: 16px; }

    /* 通用弹窗样式补全 */
    .full-screen-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; justify-content: center;
        align-items: center; z-index: 9999;
    }
    .modal-content {
        background: #fff; width: 500px; border-radius: 8px; padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .modal-header h3 { margin: 0; }
    .modal-header span { cursor: pointer; font-size: 20px; color: #999; }
    .history-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #f0f0f0; }
    .h-meta { font-size: 12px; color: #999; margin-bottom: 4px; }
    .h-content { font-size: 14px; font-weight: 500; color: #333; }
    .h-reply { font-size: 13px; color: #52c41a; background: #f6ffed; padding: 4px 8px; margin-top: 5px; border-radius: 4px; }
</style>
</head>
<body>

<div class="container">

  <div class="hero-header">
    <div class="hero-left">
      <div class="project-title" id="pName">加载中...</div>
      <div class="project-meta">
        <span class="pill-gray" id="pCode">--</span>
        <span class="pill-blue">负责人: <b id="pManager">--</b></span>
      </div>
      <div class="update-time">数据更新于: <span id="updateTime">--</span></div>
    </div>

    <div class="hero-center">
      <div class="health-gauge-container">
         <div id="healthGauge" style="width: 220px; height: 180px;"></div>
         <div class="health-status-label" id="healthText">评估中</div>
      </div>
    </div>

    <div class="hero-right">
       <div class="stat-box">
         <div class="val red" id="delayDays">15</div>
         <div class="lbl">延期天数</div>
       </div>
       <div class="stat-box">
         <div class="val" id="riskCount">0</div>
         <div class="lbl">高风险数</div>
       </div>
       <button class="btn-detail" onclick="alert('跳转到项目全景档案库')">查看全景档案 ></button>
    </div>
  </div>

  <div class="section-card">
    <div class="card-head">
      <span>全生命周期监管 (偏差分析)</span>
      <span class="hint"><i class="fas fa-hand-pointer"></i> 点击节点查看监管明细</span>
    </div>
    <div class="lifecycle-track" id="lifecycleTrack" style="padding-bottom: 40px;">
      </div>
    
    
    <div class="stage-detail-panel" id="stageDetailPanel" style="display:none;">
        <div class="arrow-up"></div>
        <div class="detail-header">
            <h3 id="modalTitle">阶段名称</h3>
            <span class="modal-status" id="modalStatus">状态</span>
            <button class="close-btn" onclick="closeDetail()">×</button>
        </div>
        <div class="detail-body">
            <div class="metrics-row" id="modalMetrics"></div>
            <div class="subtasks-list">
                <h4><i class="fas fa-list-check"></i> 关键环节执行情况</h4>
                <ul id="modalSubtasks"></ul>
            </div>
        </div>
        <div class="detail-footer">
            <a href="#" onclick="alert('打开该阶段的文档柜')">查看阶段文档库</a>
            <a href="#" onclick="alert('查看该阶段的审批流转记录')">查看审批记录</a>
        </div>
    </div>
  </div>

  <div class="grid-dashboard">
     <div class="kpi-card">
        <div class="kpi-head">
            总体进度
            <i class="fas fa-expand-alt action-icon" onclick="alert('查看甘特图详细视图')" title="查看甘特图"></i>
        </div>
        <div id="chartProgress" class="chart-box"></div>
        <div class="kpi-footer">实际耗时: <b id="actualTime">--</b> / 总工期: <span id="totalTime">--</span> 天</div>
     </div>
     
     <div class="kpi-card">
        <div class="kpi-head">
            资金支付
            <i class="fas fa-file-invoice-dollar action-icon" onclick="alert('查看资金支付台账')" title="查看支付台账"></i>
        </div>
        <div id="chartFund" class="chart-box"></div>
        <div class="kpi-footer">已用: <b id="usedFund">--</b>万 | 剩余: <b id="remainFund">--</b>万</div>
     </div>

     <div class="kpi-card">
        <div class="kpi-head">
            风险管控
            <i class="fas fa-exclamation-triangle action-icon" onclick="alert('进入风险管理系统')" title="风险台账"></i>
        </div>
        <div class="risk-big-num" id="riskBigNum">0</div>
        <div class="risk-score-display">综合风险值(P×I): <span class="risk-score-val" id="riskScore">--</span></div>
        <div class="risk-desc" onclick="alert('查看风险影响矩阵图')">当前存在高风险，请点击查看</div>
     </div>

     <div class="kpi-card supervision">
        <div class="kpi-head white">
            领导督办
            <i class="fas fa-tasks action-icon" onclick="openSupervisionModal()" title="督办记录"></i>
        </div>
        <div class="supervision-body">
            <div class="pending-badge">待办: <span id="todoCount">0</span></div>
            <p id="latestInstruction">最近暂无批示</p>
            <small style="cursor:pointer; text-decoration:underline" onclick="openSupervisionModal()">查看历史批示</small>
        </div>
     </div>
  </div>

</div>

<script>
let globalData = null;

// 模拟扩展后的 data.json 数据，增加了天数偏差、总工期、风险值
const enhancedData = {
    "project_name": "某区一体化政务服务平台建设项目",
    "project_code": "GOV-2026-001",
    "update_time": "2026-01-28 10:00",
    "health_score": 58,
    "health_status": "red",
    "team": { "manager": "张三" },
    "progress": { "plan": 85, "actual": 60, "gap": -25, "total_days": 180, "actual_days": 154 },
    "fund": { "total": 980, "used": 920, "remain": 60 },
    "risk": { "high": 2, "total": 12, "score": 78 },
    "issues": { "open": 5 },
    "stages": [
        { "name": "立项与决策", "status": "completed", "variance": 3, "metrics": {"duration": "30天"}, "sub_tasks": [] },
        { "name": "启动与规划", "status": "completed", "variance": -2, "metrics": {"duration": "15天"}, "sub_tasks": [] },
        { "name": "执行与控制", "status": "current", "variance": -15, "metrics": {"duration": "进行中"}, "sub_tasks": [] },
        { "name": "收尾验收", "status": "pending", "variance": 0, "metrics": {"duration": "--"}, "sub_tasks": [] }
    ]
};

// 初始化逻辑改为使用扩展数据
function init() {
    globalData = enhancedData;
    renderHeader(globalData);
    renderLifecycle(globalData);
    renderCharts(globalData);
}
init();

function renderHeader(data) {
    document.getElementById("pName").innerText = data.project_name;
    document.getElementById("pCode").innerText = data.project_code;
    document.getElementById("pManager").innerText = data.team.manager;
    document.getElementById("updateTime").innerText = data.update_time;
    document.getElementById("healthText").innerText = data.health_score >= 80 ? "健康" : (data.health_score >= 60 ? "预警" : "高危");
    document.getElementById("healthText").className = "health-status-label " + data.health_status;
    document.getElementById("delayDays").innerText = Math.abs(data.progress.gap);
    document.getElementById("riskCount").innerText = data.risk.high;

    const gauge = echarts.init(document.getElementById('healthGauge'));
    gauge.setOption({
        series: [{
            type: 'gauge', startAngle: 180, endAngle: 0, min: 0, max: 100,
            itemStyle: { color: data.health_status === 'red' ? '#f5222d' : '#52c41a' },
            progress: { show: true, width: 18 }, pointer: { show: false },
            axisLine: { lineStyle: { width: 18, color: [[1, '#E6EBF8']] } },
            detail: { offsetCenter: [0, '20%'], fontSize: 35, formatter: '{value}' },
            data: [{ value: data.health_score }]
        }]
    });
}

function renderLifecycle(data) {
    const track = document.getElementById("lifecycleTrack");
    let html = '';
    data.stages.forEach((stage, idx) => {
        let activeClass = stage.status === 'completed' ? 'completed' : (stage.status === 'current' ? 'current' : '');
        let varClass = stage.variance < 0 ? 'delay' : 'ahead';
        let varText = stage.variance === 0 ? '' : `${stage.variance < 0 ? '延期':'超前'} ${Math.abs(stage.variance)}天`;

        html += `
            <div class="stage-node ${activeClass}" onclick="openStageDetail(${idx}, this)">
                <div class="node-icon">${idx + 1}</div>
                <div class="node-label">${stage.name}</div>
                ${varText ? `<div class="variance-tag ${varClass}">${varText}</div>` : ''}
            </div>
        `;
        if(idx < data.stages.length - 1) {
            html += `<div class="stage-line ${stage.status === 'completed' ? 'active' : ''}"></div>`;
        }
    });
    track.innerHTML = html;
}

function renderCharts(data) {
    // 进度补全：天数
    document.getElementById("actualTime").innerText = data.progress.actual_days;
    document.getElementById("totalTime").innerText = data.progress.total_days;

    const pChart = echarts.init(document.getElementById('chartProgress'));
    pChart.setOption({
        grid: {top:10, bottom:10, left:0, right:30},
        xAxis: {type:'value', show:false},
        yAxis: {type:'category', data:['实际','计划'], show:false},
        series: [{
            type:'bar', data:[data.progress.actual, data.progress.plan],
            label: {show:true, position:'right', formatter:'{c}%'}, barWidth: 15,
            itemStyle: { color: (params) => params.dataIndex === 0 && data.progress.actual < data.progress.plan ? '#f5222d' : '#1890ff' }
        }]
    });

    // 资金补全：数值
    document.getElementById("usedFund").innerText = data.fund.used;
    document.getElementById("remainFund").innerText = data.fund.remain;
    const fChart = echarts.init(document.getElementById('chartFund'));
    fChart.setOption({
        series: [{
            type:'pie', radius:['50%','70%'],
            data: [{value:data.fund.used, name:'已用'}, {value:data.fund.remain, name:'剩余', itemStyle:{color:'#f0f2f5'}}]
        }]
    });

    // 风险补全：风险值
    document.getElementById("riskBigNum").innerText = data.risk.total;
    document.getElementById("riskScore").innerText = data.risk.score;
    document.getElementById("todoCount").innerText = data.issues.open;
}

function openSupervisionModal() {
    const historyData = [
        {date: '2026-01-25', leader: '王局长', content: '资金支付过快，请核实。', reply: '已核实，包含硬件提前采购款。'},
        {date: '2025-12-10', leader: '张区长', content: '务必保证1月底前完成核心模块。', reply: '正在赶工中。'}
    ];
    let listHtml = historyData.map(item => `
        <div class="history-item">
            <div class="h-meta"><strong>${item.leader}</strong> | ${item.date}</div>
            <div class="h-content">${item.content}</div>
            <div class="h-reply">落实反馈：${item.reply}</div>
        </div>
    `).join('');
    showGenericModal("领导督办中心", listHtml);
}

function showGenericModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'full-screen-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header"><h3>${title}</h3><span onclick="this.parentElement.parentElement.parentElement.remove()">×</span></div>
            <div class="modal-body">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openStageDetail(index, element) { /* 逻辑保持不变 */ }
function closeDetail() { /* 逻辑保持不变 */ }
</script>
</body>
</html>